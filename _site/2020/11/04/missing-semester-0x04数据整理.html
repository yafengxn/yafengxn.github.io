<h2 id="数据获取">数据获取</h2>

<p>通过日志的方式进行数据获取，比如Mac上有<code class="language-plaintext highlighter-rouge">log show</code>来展示系统日志</p>

<h2 id="数据操作">数据操作</h2>

<h4 id="常用数据操作shell命令">常用数据操作shell命令：</h4>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">grep</code>, 查找内容指定存在指定内容的行</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">less</code>, 用于数据的分页显示，数据量较大时使用该命令</p>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">sed</code>, 进行文本操作的重要工具，支持正则表达式</li>
  <li>
<code class="language-plaintext highlighter-rouge">xargs</code>,将参数列表转换成小块分段传递给其他命令，以避免参数列表过长的问题</li>
  <li>
<code class="language-plaintext highlighter-rouge">tr</code>, 用于拆分字符串</li>
  <li>
<code class="language-plaintext highlighter-rouge">var=$(pwd | sed -e xxx)</code>, 使用$(xxx)获取表达式替换的值，传给var变量</li>
</ul>

<h2 id="正则表达式">正则表达式</h2>

<h4 id="正在表达式中字符所代表含义">正在表达式中字符所代表含义</h4>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">.</code> 除空格之外的”任意单个字符”</li>
  <li>
<code class="language-plaintext highlighter-rouge">?</code>匹配前面的子表达式零次或一次</li>
  <li>
<code class="language-plaintext highlighter-rouge">*</code> 匹配前面字符零次或多次</li>
  <li>
<code class="language-plaintext highlighter-rouge">+</code> 匹配前面字符一次或多次</li>
  <li>
<code class="language-plaintext highlighter-rouge">[abc]</code> 匹配 <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code> 和 <code class="language-plaintext highlighter-rouge">c</code> 中的任意一个</li>
  <li>
<code class="language-plaintext highlighter-rouge">(RX1|RX2)</code> 任何能够匹配<code class="language-plaintext highlighter-rouge">RX1</code> 或 <code class="language-plaintext highlighter-rouge">RX2</code>的结果</li>
  <li>
<code class="language-plaintext highlighter-rouge">^</code> 行首</li>
  <li>
<code class="language-plaintext highlighter-rouge">$</code> 行尾</li>
</ul>

<p>注意: sed的正则表达式有些时候是比较奇怪的，它需要你在这些模式前添加<code class="language-plaintext highlighter-rouge">\</code>才能使其具有特殊含义。或者，您也可以添加<code class="language-plaintext highlighter-rouge">-E</code>选项来支持这些匹配</p>

<h2 id="数据整理">数据整理</h2>

<h4 id="常用数据整理命令">常用数据整理命令：</h4>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">sort</code>, 用于数据的排序，<code class="language-plaintext highlighter-rouge">-n</code>按照数字顺序进行排序，默认是按照字典序, <code class="language-plaintext highlighter-rouge">-k1,1</code> 则表示“仅基于以空格分割的第一列进行排序”, <code class="language-plaintext highlighter-rouge">-r</code>倒序排序</li>
  <li>
<code class="language-plaintext highlighter-rouge">uniq</code>, 用于数据的去重, <code class="language-plaintext highlighter-rouge">-c</code>会把连续出现的行折叠为一行并使用出现次数作为前缀</li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">head</code>, 筛选头部数据, <code class="language-plaintext highlighter-rouge">-n</code>指定显示条数</p>
  </li>
  <li>
<code class="language-plaintext highlighter-rouge">tail</code>, 筛选尾部数据, <code class="language-plaintext highlighter-rouge">-n</code>指定显示条数</li>
  <li>
<code class="language-plaintext highlighter-rouge">awk</code>, 提取空格分隔的参数, <code class="language-plaintext highlighter-rouge">$0</code>代表整行, <code class="language-plaintext highlighter-rouge">$1</code>代表第一个匹配的参数</li>
  <li>
<code class="language-plaintext highlighter-rouge">paste</code>, <code class="language-plaintext highlighter-rouge">-sd,</code>使用<code class="language-plaintext highlighter-rouge">,</code>将传入参数连接到一起</li>
  <li>
<code class="language-plaintext highlighter-rouge">wc</code>, 用于数据统计</li>
  <li>
<code class="language-plaintext highlighter-rouge">bc</code>, 用于数值计算</li>
</ul>

<h4 id="awk是另外一种编辑器">awk是另外一种编辑器</h4>

<p><code class="language-plaintext highlighter-rouge">awk</code> 其实是一种编程语言，只不过它碰巧非常善于处理文本。</p>

<p>首先， <code class="language-plaintext highlighter-rouge">{print $2}</code> 的作用是什么？ <code class="language-plaintext highlighter-rouge">awk</code> 程序接受一个模式串（可选），以及一个代码块，指定当模式匹配时应该做何种操作。默认当模式串即匹配所有行（上面命令中当用法）。 在代码块中，<code class="language-plaintext highlighter-rouge">$0</code> 表示正行的内容，<code class="language-plaintext highlighter-rouge">$1</code> 到 <code class="language-plaintext highlighter-rouge">$n</code> 为一行中的 n 个区域，区域的分割基于 <code class="language-plaintext highlighter-rouge">awk</code> 的域分隔符（默认是空格，可以通过<code class="language-plaintext highlighter-rouge">-F</code>来修改）</p>

<p>不过，既然 <code class="language-plaintext highlighter-rouge">awk</code> 是一种编程语言，那么则可以这样：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BEGIN <span class="o">{</span> rows <span class="o">=</span> 0 <span class="o">}</span>
<span class="nv">$1</span> <span class="o">==</span> 1 <span class="o">&amp;&amp;</span> <span class="nv">$2</span> ~ /^c[^ <span class="o">]</span><span class="k">*</span>e<span class="nv">$/</span> <span class="o">{</span> rows +<span class="o">=</span> <span class="nv">$1</span> <span class="o">}</span>
END <span class="o">{</span> print rows <span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">BEGIN</code> 也是一种模式，它会匹配输入的开头（ <code class="language-plaintext highlighter-rouge">END</code> 则匹配结尾）。然后，对每一行第一个部分进行累加，最后将结果输出。</p>

<h2 id="分析数据">分析数据</h2>

<p>想做数学计算也是可以的！例如这样，您可以将每行的数字加起来：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> | paste -sd+ | bc -l
</code></pre></div></div>

<p>下面这种更加复杂的表达式也可以：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "2*($(data | paste -sd+))" | bc -l
</code></pre></div></div>

<p>您可以通过多种方式获取统计数据。如果已经安装了R语言，<a href="https://github.com/nferraz/st" target="_blank" rel="noopener noreferrer nofollow"><code class="language-plaintext highlighter-rouge">st</code></a>是个不错的选择：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh myserver journalctl
 | grep sshd
 | grep "Disconnected from"
 | sed -E 's/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/'
 | sort | uniq -c
 | awk '{print $1}' | R --slave -e 'x &lt;- scan(file="stdin", quiet=TRUE); summary(x)'
</code></pre></div></div>

<p>R 也是一种编程语言，它非常适合被用来进行数据分析和<a href="https://ggplot2.tidyverse.org/" target="_blank" rel="noopener noreferrer nofollow">绘制图表</a>。这里<code class="language-plaintext highlighter-rouge">summary</code> 可以打印统计结果。我们通过输入的信息计算出一个矩阵，然后R语言就可以得到我们想要的统计数据。</p>

<p>如果您希望绘制一些简单的图表， <code class="language-plaintext highlighter-rouge">gnuplot</code> 可以帮助到您：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh myserver journalctl
 | grep sshd
 | grep "Disconnected from"
 | sed -E 's/.*Disconnected from (invalid |authenticating )?user (.*) [^ ]+ port [0-9]+( \[preauth\])?$/\2/'
 | sort | uniq -c
 | sort -nk1,1 | tail -n10
 | gnuplot -p -e 'set boxwidth 0.5; plot "-" using 1:xtic(2) with boxes'
</code></pre></div></div>

<h2 id="利用数据整理来确定参数">利用数据整理来确定参数</h2>

<p>有时候您要利用数据整理技术从一长串列表里找出你所需要安装或移除的东西。我们之前讨论的相关技术配合 <code class="language-plaintext highlighter-rouge">xargs</code> 即可实现：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rustup toolchain list | <span class="nb">grep </span>nightly | <span class="nb">grep</span> <span class="nt">-vE</span> <span class="s2">"nightly-x86"</span> | <span class="nb">sed</span> <span class="s1">'s/-x86.*//'</span> | xargs rustup toolchain uninstall
</code></pre></div></div>

<p>这里我们将整理好的数据调用<code class="language-plaintext highlighter-rouge">xargs</code>，相当于对每条数据调用一次<code class="language-plaintext highlighter-rouge">rustup toochain uninstall</code></p>

<h2 id="整理二进制数据">整理二进制数据</h2>

<p>虽然到目前为止我们的讨论都是基于文本数据，但对于二进制文件其实同样有用。例如我们可以用 ffmpeg 从相机中捕获一张图片，将其转换成灰度图后通过SSH将压缩后的文件发送到远端服务器，并在那里解压、存档并显示。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg <span class="nt">-loglevel</span> panic <span class="nt">-i</span> /dev/video0 <span class="nt">-frames</span> 1 <span class="nt">-f</span> image2 -
 | convert - <span class="nt">-colorspace</span> gray -
 | <span class="nb">gzip</span>
 | ssh mymachine <span class="s1">'gzip -d | tee copy.jpg | env DISPLAY=:0 feh -'</span>
</code></pre></div></div>
